# RUN: python %s 2>&1 | filecheck %s
"""
Test strategy Goto with reduced search space on matmul
"""
import utils
from xtc.search.strategies import Strategy_GOTO_R as Strategy

graph = utils.get_graph_matmul()
backend = utils.get_backend(graph)
strategy = Strategy(graph, max_unroll=8)

utils.print_all_opt_schedules(backend, strategy)
utils.print_exhaustive_samples(backend, strategy, 100)

# CHECK:       schedule O0: [1, 1, 1, 1, 1, 0, 0, 0]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_0', node_ident='__xtc_id_%2_0_', dims=['i', 'j'], loop_stamps=[], splits={}, tiles={'i': {}, 'j': {}}, permutation={'.': ['./i', './j']}, vectorization=[], parallelization=[], unrolling={}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={}), MlirNodeSchedule(node_name='%2', node_ident='__xtc_id_%2_', dims=['i', 'j', 'k'], loop_stamps=[], splits={}, tiles={'i': {'./i1': 1, './i2': 1}, 'j': {'./j1': 1, './j2': 1}, 'k': {'./k1': 1}}, permutation={'.': ['./j', './k', './i', './j1', './i1', './k1', './i2', './j2']}, vectorization=['./j2'], parallelization=[], unrolling={'./i2': 1, './k1': 0}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={})]
# CHECK-NEXT:  schedule O1: [1, 1, 1, 1, 1, 0, 0, 0]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_0', node_ident='__xtc_id_%2_0_', dims=['i', 'j'], loop_stamps=[], splits={}, tiles={'i': {}, 'j': {}}, permutation={'.': ['./i', './j']}, vectorization=[], parallelization=[], unrolling={}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={}), MlirNodeSchedule(node_name='%2', node_ident='__xtc_id_%2_', dims=['i', 'j', 'k'], loop_stamps=[], splits={}, tiles={'i': {'./i1': 1, './i2': 1}, 'j': {'./j1': 1, './j2': 1}, 'k': {'./k1': 1}}, permutation={'.': ['./j', './k', './i', './j1', './i1', './k1', './i2', './j2']}, vectorization=['./j2'], parallelization=[], unrolling={'./i2': 1, './k1': 0}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={})]
# CHECK-NEXT:  schedule O2: [1, 1, 1, 1, 1, 0, 0, 0]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_0', node_ident='__xtc_id_%2_0_', dims=['i', 'j'], loop_stamps=[], splits={}, tiles={'i': {}, 'j': {}}, permutation={'.': ['./i', './j']}, vectorization=[], parallelization=[], unrolling={}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={}), MlirNodeSchedule(node_name='%2', node_ident='__xtc_id_%2_', dims=['i', 'j', 'k'], loop_stamps=[], splits={}, tiles={'i': {'./i1': 1, './i2': 1}, 'j': {'./j1': 1, './j2': 1}, 'k': {'./k1': 1}}, permutation={'.': ['./j', './k', './i', './j1', './i1', './k1', './i2', './j2']}, vectorization=['./j2'], parallelization=[], unrolling={'./i2': 1, './k1': 0}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={})]
# CHECK-NEXT:  schedule O3: [1, 1, 1, 1, 1, 0, 0, 0]
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_0', node_ident='__xtc_id_%2_0_', dims=['i', 'j'], loop_stamps=[], splits={}, tiles={'i': {}, 'j': {}}, permutation={'.': ['./i', './j']}, vectorization=[], parallelization=[], unrolling={}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={}), MlirNodeSchedule(node_name='%2', node_ident='__xtc_id_%2_', dims=['i', 'j', 'k'], loop_stamps=[], splits={}, tiles={'i': {'./i1': 1, './i2': 1}, 'j': {'./j1': 1, './j2': 1}, 'k': {'./k1': 1}}, permutation={'.': ['./j', './k', './i', './j1', './i1', './k1', './i2', './j2']}, vectorization=['./j2'], parallelization=[], unrolling={'./i2': 1, './k1': 0}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={})]
# CHECK-NEXT:  sample 0: [3, 1, 2, 1, 1, 1, 0, 0]
# CHECK-NEXT:  sample 1: [3, 1, 2, 1, 1, 1, 0, 1]
# CHECK-NEXT:  sample 2: [3, 1, 2, 1, 1, 1, 1, 0]
# CHECK-NEXT:  sample 3: [3, 1, 2, 1, 1, 1, 1, 1]
# CHECK-NEXT:  sample 4: [3, 1, 2, 1, 1, 2, 0, 0]
# CHECK-NEXT:  sample 5: [3, 1, 2, 1, 1, 2, 0, 1]
# CHECK-NEXT:  sample 6: [3, 1, 2, 1, 1, 2, 1, 0]
# CHECK-NEXT:  sample 7: [3, 1, 2, 1, 1, 2, 1, 1]
# CHECK-NEXT:  sample 8: [3, 1, 2, 1, 1, 3, 0, 0]
# CHECK-NEXT:  sample 9: [3, 1, 2, 1, 1, 3, 0, 1]
# CHECK-NEXT:  sample 10: [3, 1, 2, 1, 1, 3, 1, 0]
# CHECK-NEXT:  sample 11: [3, 1, 2, 1, 1, 3, 1, 1]
# CHECK-NEXT:  sample 12: [3, 1, 2, 1, 2, 1, 0, 0]
# CHECK-NEXT:  sample 13: [3, 1, 2, 1, 2, 1, 0, 1]
# CHECK-NEXT:  sample 14: [3, 1, 2, 1, 2, 1, 1, 0]
# CHECK-NEXT:  sample 15: [3, 1, 2, 1, 2, 1, 1, 1]
# CHECK-NEXT:  sample 16: [3, 1, 2, 1, 2, 2, 0, 0]
# CHECK-NEXT:  sample 17: [3, 1, 2, 1, 2, 2, 0, 1]
# CHECK-NEXT:  sample 18: [3, 1, 2, 1, 2, 2, 1, 0]
# CHECK-NEXT:  sample 19: [3, 1, 2, 1, 2, 2, 1, 1]
# CHECK-NEXT:  sample 20: [3, 1, 2, 1, 2, 3, 0, 0]
# CHECK-NEXT:  sample 21: [3, 1, 2, 1, 2, 3, 0, 1]
# CHECK-NEXT:  sample 22: [3, 1, 2, 1, 2, 3, 1, 0]
# CHECK-NEXT:  sample 23: [3, 1, 2, 1, 2, 3, 1, 1]
# CHECK-NEXT:  sample 24: [3, 1, 2, 1, 3, 1, 0, 0]
# CHECK-NEXT:  sample 25: [3, 1, 2, 1, 3, 1, 0, 1]
# CHECK-NEXT:  sample 26: [3, 1, 2, 1, 3, 1, 1, 0]
# CHECK-NEXT:  sample 27: [3, 1, 2, 1, 3, 1, 1, 1]
# CHECK-NEXT:  sample 28: [3, 1, 2, 1, 3, 2, 0, 0]
# CHECK-NEXT:  sample 29: [3, 1, 2, 1, 3, 2, 0, 1]
# CHECK-NEXT:  sample 30: [3, 1, 2, 1, 3, 2, 1, 0]
# CHECK-NEXT:  sample 31: [3, 1, 2, 1, 3, 2, 1, 1]
# CHECK-NEXT:  sample 32: [3, 1, 2, 1, 4, 1, 0, 0]
# CHECK-NEXT:  sample 33: [3, 1, 2, 1, 4, 1, 0, 1]
# CHECK-NEXT:  sample 34: [3, 1, 2, 1, 4, 1, 1, 0]
# CHECK-NEXT:  sample 35: [3, 1, 2, 1, 4, 1, 1, 1]
# CHECK-NEXT:  sample 36: [3, 1, 2, 1, 4, 3, 0, 0]
# CHECK-NEXT:  sample 37: [3, 1, 2, 1, 4, 3, 0, 1]
# CHECK-NEXT:  sample 38: [3, 1, 2, 1, 4, 3, 1, 0]
# CHECK-NEXT:  sample 39: [3, 1, 2, 1, 4, 3, 1, 1]
# CHECK-NEXT:  sample 40: [3, 1, 2, 1, 6, 1, 0, 0]
# CHECK-NEXT:  sample 41: [3, 1, 2, 1, 6, 1, 0, 1]
# CHECK-NEXT:  sample 42: [3, 1, 2, 1, 6, 1, 1, 0]
# CHECK-NEXT:  sample 43: [3, 1, 2, 1, 6, 1, 1, 1]
# CHECK-NEXT:  sample 44: [3, 1, 2, 1, 6, 2, 0, 0]
# CHECK-NEXT:  sample 45: [3, 1, 2, 1, 6, 2, 0, 1]
# CHECK-NEXT:  sample 46: [3, 1, 2, 1, 6, 2, 1, 0]
# CHECK-NEXT:  sample 47: [3, 1, 2, 1, 6, 2, 1, 1]
# CHECK-NEXT:  sample 48: [3, 1, 2, 1, 12, 1, 0, 0]
# CHECK-NEXT:  sample 49: [3, 1, 2, 1, 12, 1, 0, 1]
# CHECK-NEXT:  sample 50: [3, 1, 2, 1, 12, 1, 1, 0]
# CHECK-NEXT:  sample 51: [3, 1, 2, 1, 12, 1, 1, 1]
# CHECK-NEXT:  sample 52: [3, 1, 2, 2, 1, 1, 0, 0]
# CHECK-NEXT:  sample 53: [3, 1, 2, 2, 1, 1, 0, 1]
# CHECK-NEXT:  sample 54: [3, 1, 2, 2, 1, 1, 1, 0]
# CHECK-NEXT:  sample 55: [3, 1, 2, 2, 1, 1, 1, 1]
# CHECK-NEXT:  sample 56: [3, 1, 2, 2, 1, 2, 0, 0]
# CHECK-NEXT:  sample 57: [3, 1, 2, 2, 1, 2, 0, 1]
# CHECK-NEXT:  sample 58: [3, 1, 2, 2, 1, 2, 1, 0]
# CHECK-NEXT:  sample 59: [3, 1, 2, 2, 1, 2, 1, 1]
# CHECK-NEXT:  sample 60: [3, 1, 2, 2, 1, 3, 0, 0]
# CHECK-NEXT:  sample 61: [3, 1, 2, 2, 1, 3, 0, 1]
# CHECK-NEXT:  sample 62: [3, 1, 2, 2, 1, 3, 1, 0]
# CHECK-NEXT:  sample 63: [3, 1, 2, 2, 1, 3, 1, 1]
# CHECK-NEXT:  sample 64: [3, 1, 2, 2, 2, 1, 0, 0]
# CHECK-NEXT:  sample 65: [3, 1, 2, 2, 2, 1, 0, 1]
# CHECK-NEXT:  sample 66: [3, 1, 2, 2, 2, 1, 1, 0]
# CHECK-NEXT:  sample 67: [3, 1, 2, 2, 2, 1, 1, 1]
# CHECK-NEXT:  sample 68: [3, 1, 2, 2, 2, 2, 0, 0]
# CHECK-NEXT:  sample 69: [3, 1, 2, 2, 2, 2, 0, 1]
# CHECK-NEXT:  sample 70: [3, 1, 2, 2, 2, 2, 1, 0]
# CHECK-NEXT:  sample 71: [3, 1, 2, 2, 2, 2, 1, 1]
# CHECK-NEXT:  sample 72: [3, 1, 2, 2, 2, 3, 0, 0]
# CHECK-NEXT:  sample 73: [3, 1, 2, 2, 2, 3, 0, 1]
# CHECK-NEXT:  sample 74: [3, 1, 2, 2, 2, 3, 1, 0]
# CHECK-NEXT:  sample 75: [3, 1, 2, 2, 2, 3, 1, 1]
# CHECK-NEXT:  sample 76: [3, 1, 2, 2, 3, 1, 0, 0]
# CHECK-NEXT:  sample 77: [3, 1, 2, 2, 3, 1, 0, 1]
# CHECK-NEXT:  sample 78: [3, 1, 2, 2, 3, 1, 1, 0]
# CHECK-NEXT:  sample 79: [3, 1, 2, 2, 3, 1, 1, 1]
# CHECK-NEXT:  sample 80: [3, 1, 2, 2, 3, 2, 0, 0]
# CHECK-NEXT:  sample 81: [3, 1, 2, 2, 3, 2, 0, 1]
# CHECK-NEXT:  sample 82: [3, 1, 2, 2, 3, 2, 1, 0]
# CHECK-NEXT:  sample 83: [3, 1, 2, 2, 3, 2, 1, 1]
# CHECK-NEXT:  sample 84: [3, 1, 2, 2, 4, 1, 0, 0]
# CHECK-NEXT:  sample 85: [3, 1, 2, 2, 4, 1, 0, 1]
# CHECK-NEXT:  sample 86: [3, 1, 2, 2, 4, 1, 1, 0]
# CHECK-NEXT:  sample 87: [3, 1, 2, 2, 4, 1, 1, 1]
# CHECK-NEXT:  sample 88: [3, 1, 2, 2, 4, 3, 0, 0]
# CHECK-NEXT:  sample 89: [3, 1, 2, 2, 4, 3, 0, 1]
# CHECK-NEXT:  sample 90: [3, 1, 2, 2, 4, 3, 1, 0]
# CHECK-NEXT:  sample 91: [3, 1, 2, 2, 4, 3, 1, 1]
# CHECK-NEXT:  sample 92: [3, 1, 2, 2, 6, 1, 0, 0]
# CHECK-NEXT:  sample 93: [3, 1, 2, 2, 6, 1, 0, 1]
# CHECK-NEXT:  sample 94: [3, 1, 2, 2, 6, 1, 1, 0]
# CHECK-NEXT:  sample 95: [3, 1, 2, 2, 6, 1, 1, 1]
# CHECK-NEXT:  sample 96: [3, 1, 2, 2, 6, 2, 0, 0]
# CHECK-NEXT:  sample 97: [3, 1, 2, 2, 6, 2, 0, 1]
# CHECK-NEXT:  sample 98: [3, 1, 2, 2, 6, 2, 1, 0]
# CHECK-NEXT:  sample 99: [3, 1, 2, 2, 6, 2, 1, 1]
# CHECK-NEXT:  stats {'filtered': 3256, 'all': 6620}
# CHECK-NEXT:  [MlirNodeSchedule(node_name='%2_0', node_ident='__xtc_id_%2_0_', dims=['i', 'j'], loop_stamps=[], splits={}, tiles={'i': {}, 'j': {}}, permutation={'.': ['./i', './j']}, vectorization=[], parallelization=[], unrolling={}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={}), MlirNodeSchedule(node_name='%2', node_ident='__xtc_id_%2_', dims=['i', 'j', 'k'], loop_stamps=[], splits={}, tiles={'i': {'./i1': 3, './i2': 1}, 'j': {'./j1': 4, './j2': 2}, 'k': {'./k1': 6}}, permutation={'.': ['./j', './k', './i', './j1', './i1', './k1', './i2', './j2']}, vectorization=['./j2'], parallelization=[], unrolling={'./i2': 1, './k1': 2}, packed_buffers={}, memory_mesh={}, processor_mesh={}, distribution={}, distributed_buffers={})]
