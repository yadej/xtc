import lit.formats
import os
import importlib.util

config.name = "xtc"
config.test_format = lit.formats.ShTest()
config.suffixes = ['.mlir', '.py']

config.test_source_root = os.path.dirname(__file__)
config.excludes = ['utils.py', 'experimental']
config.environment["TIMEOUT"] = "10"

config.available_features = set()

for module in ["mlir", "tvm", "jir", "mlir_sdist"]:
    if importlib.util.find_spec(module) is not None:
        config.available_features.add(f"module_{module}")
    else:
        config.available_features.add(f"no_module_{module}")

os.environ["XTC_MLIR_TARGET"] = os.getenv("XTC_MLIR_TARGET", "llvmir")
config.available_features.add("mlir-target=%s" % os.getenv("XTC_MLIR_TARGET"))

# Environment passed to subprocesses
env_passthrough = [
    "COVERAGE_PROCESS_START",
    "COVERAGE_FILE",
    "PYTHONPATH",
    "XTC_MLIR_TARGET",
    "XTC_MLIR_PREFIX",
]
config.environment.update({
    var: os.environ[var]
    for var in env_passthrough
    if var in os.environ
})
